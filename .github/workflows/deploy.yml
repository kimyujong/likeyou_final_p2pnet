name: Deploy P2PNet API (GPU)

on:
  push:
    branches: [ "main" ]
    # (ì„ íƒ) m3 í´ë”ê°€ ë³€ê²½ë  ë•Œë§Œ ë°°í¬í•˜ë ¤ë©´ ì•„ë˜ ê²½ë¡œ í•„í„° ì¶”ê°€
    # paths:
    #   - 'm3/**'

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GPU Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GPU_EC2_HOST }}  # GPU ì„œë²„ìš© ì‹œí¬ë¦¿ í•„ìš”
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘: P2PNet API (GPU)"
            
            git config --global --add safe.directory /home/ubuntu/p2pnet-api

            # 1. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            cd /home/ubuntu/p2pnet-api
            
            # 2. ìµœì‹  ì½”ë“œ ë°›ê¸°
            git fetch --all
            git reset --hard origin/main
            
            # 3. ê°€ìƒí™˜ê²½ í™œì„±í™” ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
            # GPU ì„œë²„ì—ì„œëŠ” ì•„ê¹Œ ë§Œë“  'p2pnet' Conda í™˜ê²½ì´ë‚˜ 'venv' ì‚¬ìš©
            source /home/ubuntu/p2pnet-api/p2pnet_env/bin/activate
            
            # m3 í´ë”ë¡œ ì´ë™í•´ì„œ ì˜ì¡´ì„± ì„¤ì¹˜
            cd m3
            pip install -r requirements.txt
            
            # 4. PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ (ecosystem íŒŒì¼ ì—†ìŒ!)
            # ì•„ê¹Œ pm2 start ... --name "m3-gpu" ë¡œ ì‹¤í–‰í–ˆìœ¼ë¯€ë¡œ ì´ë¦„ìœ¼ë¡œ ì¬ì‹œì‘
            pm2 restart m3-gpu --update-env
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
