name: Deploy P2PNet API (GPU)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GPU Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘: P2PNet API (GPU)"
            
            git config --global --add safe.directory /home/ubuntu/p2pnet-api

            # 1. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            cd /home/ubuntu/p2pnet-api
            
            # 2. ìµœì‹  ì½”ë“œ ë°›ê¸° (ë³€ê²½ ì‚¬í•­ ì ìš©)
            git fetch --all
            git reset --hard origin/main
            
            # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (í•„ìš”í•  ë•Œë§Œ)
            # ê°€ìƒí™˜ê²½ í™œì„±í™” (p2pnet_env ê²½ë¡œ)
            source /home/ubuntu/p2pnet_env/bin/activate
            
            cd m3
            # requirements.txtê°€ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì„¤ì¹˜ ì‹œë„
            pip install -r requirements.txt
            
            # 4. PM2 ì¬ì‹œì‘ (Zero Downtime Reload)
            # ecosystem.config.jsê°€ ë£¨íŠ¸(p2pnet-api)ì— ìˆë‹¤ê³  ê°€ì •
            cd /home/ubuntu/p2pnet-api
            
            # ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì—ê²Œ "ìƒˆ ì½”ë“œ ì½ê³  ì¬ì‹œì‘í•´!" ëª…ë ¹
            # ë§Œì•½ ecosystem ì„¤ì • ìì²´ê°€ ë°”ë€Œì—ˆë‹¤ë©´ startë¡œ ì ìš©, ì•„ë‹ˆë©´ restart
            pm2 start ecosystem.config.js
            
            # 5. ìƒíƒœ ì €ì¥ (í˜¹ì‹œ ëª¨ë¥´ë‹ˆ)
            pm2 save
            
            echo "âœ… ë°°í¬ ì™„ë£Œ! (PM2 Reloaded)"
