name: Deploy P2PNet API (GPU)

on:
  push:
    branches: [ "main" ]
    # (ì„ íƒ) m3 í´ë”ê°€ ë³€ê²½ë  ë•Œë§Œ ë°°í¬í•˜ë ¤ë©´ ì•„ë˜ ê²½ë¡œ í•„í„° ì¶”ê°€
    # paths:
    #   - 'm3/**'

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GPU Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}  # GPU ì„œë²„ìš© ì‹œí¬ë¦¿ í•„ìš”
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘: P2PNet API (GPU)"
            
            git config --global --add safe.directory /home/ubuntu/p2pnet-api

            # 1. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            cd /home/ubuntu/p2pnet-api
            
            # 2. ìµœì‹  ì½”ë“œ ë°›ê¸°
            git fetch --all
            git reset --hard origin/main
            
            # 3. ê°€ìƒí™˜ê²½ í™œì„±í™” ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
            # GPU ì„œë²„ì—ì„œëŠ” ì•„ê¹Œ ë§Œë“  'p2pnet' Conda í™˜ê²½ì´ë‚˜ 'venv' ì‚¬ìš©
            source /home/ubuntu/p2pnet-api/p2pnet_env/bin/activate
            
            # m3 í´ë”ë¡œ ì´ë™í•´ì„œ ì˜ì¡´ì„± ì„¤ì¹˜
            cd m3
            pip install -r requirements.txt
            
            # 4. PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ (ecosystem íŒŒì¼ ì—†ìŒ!)
            # ì•„ê¹Œ pm2 start ... --name "m3-gpu" ë¡œ ì‹¤í–‰í–ˆìœ¼ë¯€ë¡œ ì´ë¦„ìœ¼ë¡œ ì¬ì‹œì‘
            pm2 delete m3-gpu || true
            
            # 4-2. (ì¤‘ìš”) 8003 í¬íŠ¸ë¥¼ ì¡ê³  ìˆëŠ” ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ í™•ì‹¤íˆ ì‚¬ì‚´
            # fuser ëª…ë ¹ì–´ë¡œ 8003/tcp í¬íŠ¸ ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì•„ì„œ kill (-k)
            # fuserê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ lsofë‚˜ netstat ëŒ€ìš©ë„ ê³ ë ¤í•˜ì§€ë§Œ, ë³´í†µ ubuntuì—” fuser ì„¤ì¹˜ë¨
            fuser -k 8003/tcp || true
            
            # ì ì‹œ ëŒ€ê¸° (OSê°€ ë¦¬ì†ŒìŠ¤ ì •ë¦¬í•  ì‹œê°„)
            sleep 2
            
            # 4-3. PM2 ìƒˆë¡œ ì‹œì‘ (ê°€ìƒí™˜ê²½ ì¸í„°í”„ë¦¬í„° ëª…ì‹œ)
            pm2 start server.py --name "m3-gpu" \
              --interpreter /home/ubuntu/p2pnet_env/bin/python \
              --time
            
            pm2 save
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
